<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>전체 상품</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 12px;
            background: #f6f6f6;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            transition: .15s ease;
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.08);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .filter-card {
            position: sticky;
            top: 1rem;
        }
    </style>
</head>

<body class="bg-light">
<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="container py-4">
    <h3 class="fw-bold mb-4">전체 상품</h3>

    <div class="row">
        <!-- Left Sidebar - Filters -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card shadow-sm rounded-4 filter-card">
                <div class="card-header bg-white rounded-top-4">
                    <h5 class="mb-0">필터</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/products/search}" method="get">

                        <!-- Keyword -->
                        <div class="mb-3">
                            <label for="keyword" class="form-label fw-semibold">검색어</label>
                            <input type="text" class="form-control" id="keyword" name="keyword"
                                   th:value="${search?.keyword}" placeholder="상품명 입력">
                        </div>

                        <!-- Price Range -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">가격대</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control" name="minPrice"
                                           th:value="${search?.minPrice}" placeholder="최소" min="0">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" name="maxPrice"
                                           th:value="${search?.maxPrice}" placeholder="최대" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Sort -->
                        <div class="mb-3">
                            <label for="sortType" class="form-label fw-semibold">정렬</label>
                            <select class="form-select" id="sortType" name="sortType">
                                <option th:each="s : ${sortTypes}"
                                        th:value="${s.name()}"
                                        th:text="${s.label}"
                                        th:selected="${s == search?.sortType}">
                                </option>
                            </select>
                        </div>

                        <!-- Sales Period (shown only when BEST_SELLING is selected) -->
                        <div class="mb-3" id="salesPeriodGroup">
                            <label for="salesPeriod" class="form-label fw-semibold">판매 기간</label>
                            <select class="form-select" id="salesPeriod" name="salesPeriod">
                                <option th:each="p : ${salesPeriods}"
                                        th:value="${p.name()}"
                                        th:text="${p.label}"
                                        th:selected="${p == search?.salesPeriod}">
                                </option>
                            </select>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">검색</button>
                            <a th:href="@{/products/search}" class="btn btn-outline-secondary">초기화</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Content - Results -->
        <div class="col-lg-9 col-md-8">
            <!-- Results count -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-secondary" th:if="${page != null}">
                    검색 결과: <span th:text="${page.totalElements}">0</span>개
                </span>
            </div>

            <!-- Product Grid -->
            <div class="row g-3" th:if="${products != null and !#lists.isEmpty(products)}">
                <div class="col-6 col-lg-4" th:each="p : ${products}">
                    <div class="card card-hover shadow-sm rounded-4 h-100">
                        <a th:href="@{/products/{id}(id=${p.id})}" class="text-decoration-none text-dark">
                            <div class="p-3">
                                <img class="product-img" th:src="@{${p.mainImageUrl}}" alt="product">
                            </div>
                            <div class="card-body pt-0">
                                <h6 class="fw-semibold line-clamp-2 mb-2" th:text="${p.name}">상품명</h6>
                                <div class="fw-bold" th:text="${#numbers.formatInteger(p.price,0,'COMMA')} + '원'">10,000원</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- No results -->
            <div class="alert alert-secondary rounded-4"
                 th:if="${products == null or #lists.isEmpty(products)}">
                검색 결과가 없습니다.
            </div>

            <!-- Pagination -->
            <th:block th:with="qs=${
                (search?.keyword != null and !#strings.isEmpty(search.keyword) ? 'keyword=' + search.keyword : '') +
                (search?.minPrice != null ? '&minPrice=' + search.minPrice : '') +
                (search?.maxPrice != null ? '&maxPrice=' + search.maxPrice : '') +
                '&sortType=' + (search?.sortType != null ? search.sortType.name() : 'NEWEST') +
                '&salesPeriod=' + (search?.salesPeriod != null ? search.salesPeriod.name() : 'MONTH')
            }">
                <div th:replace="~{fragments/pagination :: pager('/products/search', ${page}, ${qs})}"></div>
            </th:block>
        </div>
    </div>
</main>

<script>
    // Show/hide sales period based on sort type selection
    document.addEventListener('DOMContentLoaded', function() {
        const sortSelect = document.getElementById('sortType');
        const salesPeriodGroup = document.getElementById('salesPeriodGroup');

        function toggleSalesPeriod() {
            if (sortSelect.value === 'BEST_SELLING') {
                salesPeriodGroup.style.display = 'block';
            } else {
                salesPeriodGroup.style.display = 'none';
            }
        }

        sortSelect.addEventListener('change', toggleSalesPeriod);
        toggleSalesPeriod(); // Initial state
    });
</script>

</body>
</html>

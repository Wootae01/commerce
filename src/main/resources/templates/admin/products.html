<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a2e0b4b8d6.js" crossorigin="anonymous"></script>

    <style>
        .thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
        .rank-input {
            width: 90px;
        }
    </style>
</head>

<body class="bg-light">
<div th:replace="~{fragments/admin-header :: adminHeader}"></div>

<div class="container py-5">
    <h2 class="mb-4 fw-bold text-center">ğŸ›’ ìƒí’ˆ ê´€ë¦¬</h2>

    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- ê²€ìƒ‰ -->
        <form class="d-flex" method="get" action="/admin/products/search">
            <input class="form-control me-2" type="text" name="keyword" placeholder="ìƒí’ˆëª… ê²€ìƒ‰"
                   th:value="${param.keyword}">
            <button class="btn btn-outline-primary" type="submit">ê²€ìƒ‰</button>
        </form>

        <div class="d-flex gap-2">
            <a href="/admin/products/new" class="btn btn-success">
                ìƒí’ˆ ë“±ë¡
            </a>

            <!-- âœ… í™ˆ ë…¸ì¶œ ì €ì¥ ë²„íŠ¼: ì•„ë˜ featureForm ì œì¶œ -->
            <button class="btn btn-primary" type="submit" form="featureForm">
                í™ˆ ë…¸ì¶œ ì €ì¥
            </button>
        </div>
    </div>

    <!-- âœ… í™ˆ(ê´€ë¦¬ìí”½) ì„¤ì • ì €ì¥ í¼ -->
    <form id="featureForm" method="post" action="/admin/products/featured">

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>ì´ë¯¸ì§€</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ê°€ê²©</th>
                        <th>ì¬ê³ </th>
                        <th>ë“±ë¡ì¼</th>

                        <!-- âœ… ì¶”ê°€ -->
                        <th class="text-center">í™ˆ ë…¸ì¶œ</th>
                        <th class="text-center">ìˆœì„œ</th>

                        <th class="text-center">ê´€ë¦¬</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="product, stat : ${products}">
                        <td th:text="${product.id}"></td>

                        <td>
                            <img th:src="@{${product.mainImageUrl}}"
                                 alt="ìƒí’ˆ ëŒ€í‘œ ì´ë¯¸ì§€"
                                 class="rounded thumb">
                        </td>

                        <td th:text="${product.name}"></td>

                        <td th:text="${#numbers.formatInteger(product.price, 3, 'COMMA')} + 'ì›'"></td>

                        <td>
                            <span th:if="${product.stock > 0}" class="badge bg-success" th:text="${product.stock}"></span>
                            <span th:if="${product.stock == 0}" class="badge bg-danger">í’ˆì ˆ</span>
                        </td>

                        <td th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"></td>

                        <!-- âœ… í¼ ë°”ì¸ë”©: items[i].productId / featured / featuredRank -->
                        <td class="text-center">
                            <input type="hidden"
                                   th:name="|items[${stat.index}].productId|"
                                   th:value="${product.id}"/>

                            <input class="form-check-input featured-check"
                                   type="checkbox"
                                   th:name="|items[${stat.index}].featured|"
                                   th:checked="${product.featured}"/>
                        </td>

                        <td class="text-center">
                            <input class="form-control form-control-sm d-inline-block rank-input featured-rank"
                                   type="number" min="1" max="999"
                                   th:name="|items[${stat.index}].featuredRank|"
                                   th:value="${product.featuredRank}"
                                   th:disabled="${!product.featured}"
                                   placeholder="ì˜ˆ: 1"/>
                            <div class="form-text small">ì‘ì„ìˆ˜ë¡ ìƒë‹¨</div>
                        </td>

                        <td class="text-center">
                            <a th:href="@{'/admin/products/edit/' + ${product.id}}"
                               class="btn btn-sm btn-primary">
                                ìˆ˜ì •
                            </a>
                            <form th:action="@{'/admin/products/delete/' + ${product.id}}"
                                  method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                    ì‚­ì œ
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- (ì„ íƒ) ì•ˆë‚´ë¬¸ -->
        <div class="mt-3 text-secondary small">
            * í™ˆ ë…¸ì¶œ ì²´í¬ í›„ ìˆœì„œë¥¼ ì…ë ¥í•˜ê³  â€œí™ˆ ë…¸ì¶œ ì €ì¥â€ì„ ëˆ„ë¥´ë©´ ë°˜ì˜ë©ë‹ˆë‹¤. <br>
            * ì²´í¬ í•´ì œ ì‹œ ìˆœì„œëŠ” ìë™ìœ¼ë¡œ ë¹„ì›Œì§‘ë‹ˆë‹¤.
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ì²´í¬ë°•ìŠ¤ í† ê¸€ ì‹œ rank ì…ë ¥ í™œì„±/ë¹„í™œì„± + í•´ì œë©´ rank ë¹„ìš°ê¸°
    document.addEventListener("change", (e) => {
        if (!e.target.classList.contains("featured-check")) return;

        const tr = e.target.closest("tr");
        const rankInput = tr.querySelector(".featured-rank");
        if (!rankInput) return;

        if (e.target.checked) {
            rankInput.disabled = false;
            if (!rankInput.value) rankInput.focus();
        } else {
            rankInput.value = "";
            rankInput.disabled = true;
        }
    });

    // ì €ì¥ ì „ ê°„ë‹¨ ê²€ì¦: ì²´í¬ëœ í–‰ì€ rank í•„ìˆ˜
    document.getElementById("featureForm").addEventListener("submit", (e) => {
        const rows = document.querySelectorAll("tbody tr");
        for (const tr of rows) {
            const chk = tr.querySelector(".featured-check");
            const rank = tr.querySelector(".featured-rank");
            if (chk && chk.checked) {
                if (!rank.value || Number(rank.value) <= 0) {
                    e.preventDefault();
                    alert("í™ˆ ë…¸ì¶œë¡œ ì„ íƒëœ ìƒí’ˆì€ ìˆœì„œ(rank)ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                    rank.focus();
                    return;
                }
            }
        }
    });
</script>

</body>
</html>

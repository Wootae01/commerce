<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>결제 처리 중...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div class="container py-5" style="max-width: 520px;">
    <div class="card shadow-sm">
        <div class="card-body p-4 text-center">
            <div class="spinner-border" role="status" aria-label="결제 승인 처리 중">
                <span class="visually-hidden">Loading...</span>
            </div>

            <h4 class="mt-3 mb-1">결제 승인 처리 중...</h4>
            <p class="text-muted mb-0">
                잠시만 기다려 주세요. 창을 닫거나 새로고침하지 마세요.
            </p>

            <hr class="my-4"/>

            <div class="text-start small text-muted">
                <div>주문번호: <span id="orderIdText">-</span></div>
                <div>금액: <span id="amountText">-</span></div>
            </div>

            <div class="alert alert-danger mt-3 d-none" id="errorBox" role="alert"></div>
            <button type="button" class="btn btn-outline-secondary w-100 mt-2 d-none" id="retryBtn">
                다시 시도
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentKey = urlParams.get("paymentKey");
        const orderId = urlParams.get("orderId");
        const amount = Number(urlParams.get("amount"));

        const orderIdText = document.getElementById("orderIdText");
        const amountText = document.getElementById("amountText");
        const errorBox = document.getElementById("errorBox");
        const retryBtn = document.getElementById("retryBtn");

        orderIdText.textContent = orderId ?? "-";
        amountText.textContent = amount ? (amount + "원") : "-";

        // 필수 파라미터 누락 방어
        if (!paymentKey || !orderId || !amount) {
            showError("결제 정보가 올바르지 않습니다. (파라미터 누락)");
            return;
        }

        // 새로고침/뒤로가기 등으로 중복 호출되는 걸 약간 완화
        const confirmOnceKey = `confirm_once:${paymentKey}`;
        if (sessionStorage.getItem(confirmOnceKey) === "1") {
            // 이미 confirm을 시도한 적이 있으면 성공/실패 페이지로 보내는 게 낫다.
            // (정확한 상태는 서버에서 조회하는 게 베스트지만, 일단 중복 호출 방지 목적)
            window.location.replace(`/pay/success?orderId=${encodeURIComponent(orderId)}`);
            return;
        }

        retryBtn.addEventListener("click", () => {
            errorBox.classList.add("d-none");
            retryBtn.classList.add("d-none");
            doConfirm();
        });

        doConfirm();

        async function doConfirm() {
            try {
                sessionStorage.setItem(confirmOnceKey, "1");

                const requestData = {
                    paymentKey,
                    orderId,
                    amount
                };

                const res = await fetch("/pay/confirm", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestData)
                });

                const json = await res.json().catch(() => ({}));

                if (!res.ok) {
                    const msg = json?.message ?? "결제 승인에 실패했습니다.";
                    const code = json?.code ? `(${json.code})` : "";
                    window.location.replace(`/pay/fail?message=${encodeURIComponent(msg)}&code=${encodeURIComponent(code)}`);
                    return;
                }

                // 승인 성공 → 성공 페이지로 이동 (원하면 paymentKey/amount도 넘겨도 됨)
                window.location.replace(`/pay/success?orderId=${encodeURIComponent(orderId)}`);

            } catch (e) {
                // 네트워크 오류 등
                sessionStorage.removeItem(confirmOnceKey); // 재시도 가능하게
                showError("네트워크 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.");
            }
        }

        function showError(message) {
            errorBox.textContent = message;
            errorBox.classList.remove("d-none");
            retryBtn.classList.remove("d-none");
        }
    })();
</script>
</body>
</html>

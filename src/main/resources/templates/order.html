<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ë¬¸í•˜ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <style>
        .section-title {
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .price-box {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }
    </style>

    <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  SDK ì¶”ê°€ -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>

<body class="bg-light">

<div class="container py-5">

    <!-- í˜ì´ì§€ ì œëª© -->
    <h2 class="fw-bold mb-4 text-center">ğŸ§¾ ì£¼ë¬¸í•˜ê¸°</h2>

    <form th:action="@{/orders}" method="post" th:object="${orderForm}">

        <!-- orderTypeë„ ê°™ì´ ì „ì†¡ -->
        <input type="hidden" th:field="*{orderType}"/>

        <!-- ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ -->
        <div class="section-title">ì£¼ë¬¸ ìƒí’ˆ</div>
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>ìƒí’ˆ ì •ë³´</th>
                            <th class="text-center" style="width:120px">ìˆ˜ëŸ‰</th>
                            <th class="text-end" style="width:140px">ìƒí’ˆê¸ˆì•¡</th>
                            <th class="text-end" style="width:140px">í•©ê³„</th>
                        </tr>
                        </thead>

                        <tbody>
                        <!-- ì£¼ë¬¸ ìƒí’ˆ ë£¨í”„ -->
                        <tr th:each="orderItem : ${orderItems}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <img th:src="@{${orderItem.mainImageUrl}}"
                                         alt="ìƒí’ˆ ì´ë¯¸ì§€"
                                         class="order-item-img me-3 rounded"
                                         style="width:60px; height:60px; object-fit:cover;">
                                    <div>
                                        <div class="fw-semibold" th:text="${orderItem.name}">
                                            ìƒí’ˆëª…
                                        </div>
                                        <div class="text-muted small"
                                             th:text="'ìˆ˜ëŸ‰: ' + ${orderItem.quantity} + 'ê°œ'">
                                            ìˆ˜ëŸ‰: 1ê°œ
                                        </div>
                                    </div>
                                </div>

                                <!-- ì¥ë°”êµ¬ë‹ˆ ì£¼ë¬¸ì¼ ë•Œ: cartProductIds ë¦¬ìŠ¤íŠ¸ë¡œ ë°”ì¸ë”© -->
                                <input type="hidden"
                                       th:if="${orderForm.orderType == T(com.commerce.domain.enums.OrderType).CART}"
                                       name="cartProductIds"
                                       th:value="${orderItem.id}"/>
                            </td>

                            <!-- ìˆ˜ëŸ‰ -->
                            <td class="text-center">
                                <span th:text="${orderItem.quantity}">1</span>ê°œ
                            </td>

                            <!-- ìƒí’ˆ ë‹¨ê°€ -->
                            <td class="text-end">
                        <span th:text="${#numbers.formatInteger(orderItem.unitPrice, 3, 'COMMA')}">
                            10,000
                        </span> ì›
                            </td>

                            <!-- í•©ê³„ = ë‹¨ê°€ * ìˆ˜ëŸ‰ -->
                            <td class="text-end">
                        <span th:text="${#numbers.formatInteger(orderItem.totalPrice, 3, 'COMMA')}">
                            10,000
                        </span> ì›
                            </td>
                        </tr>

                        </tbody>
                    </table>
                </div>

                <!-- ì´ ìƒí’ˆ ê¸ˆì•¡ -->
                <div class="text-end fw-bold mt-3">
                    ì´ ìƒí’ˆ ê¸ˆì•¡:
                    <span th:text="${#numbers.formatInteger(orderPrice.totalPrice, 3, 'COMMA')} + 'ì›'"
                          class="text-danger">
                0ì›
            </span>
                </div>

                <!-- ì¦‰ì‹œ êµ¬ë§¤ì¼ ë•Œ: productId, quantity hiddenìœ¼ë¡œ ì „ì†¡ -->
                <input type="hidden"
                       th:if="${orderForm.orderType == T(com.commerce.domain.enums.OrderType).BUY_NOW}"
                       th:field="*{productId}"/>
                <input type="hidden"
                       th:if="${orderForm.orderType == T(com.commerce.domain.enums.OrderType).BUY_NOW}"
                       th:field="*{quantity}"/>

            </div>
        </div>


        <!-- ë°°ì†¡ ì •ë³´ -->
        <div class="section-title">ë°°ì†¡ ì •ë³´</div>
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <div class="mb-3">
                    <label class="form-label">ë°›ëŠ” ì‚¬ëŒ</label>
                    <input type="text" class="form-control" th:field="*{name}" th:errorclass="is-invalid">
                    <div class="invalid-feedback" th:errors="*{name}">ì´ë¦„ ì˜¤ë¥˜</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ì—°ë½ì²˜</label>
                    <input type="text" class="form-control" th:field="*{phone}" th:errorclass="is-invalid">
                    <div class="invalid-feedback" th:errors="*{phone}">ì „í™”ë²ˆí˜¸ ì˜¤ë¥˜</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ì£¼ì†Œ</label>
                    <input type="text" class="form-control mb-2" th:field="*{address}" th:errorclass="is-invalid">
                    <div class="invalid-feedback" th:errors="*{address}">ì£¼ì†Œ ì˜¤ë¥˜</div>
                    <input type="text" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥" th:field="*{addressDetail}" th:errorclass="is-invalid">
                    <div class="invalid-feedback" th:errors="*{addressDetail}">ìƒì„¸ ì£¼ì†Œ ì˜¤ë¥˜</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ìš”ì²­ ì‚¬í•­</label>
                    <textarea class="form-control" rows="3" th:field="*{requestNote}"></textarea>
                </div>

            </div>
        </div>


        <!-- ê²°ì œ ë°©ì‹ -->
        <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
            <!-- ê²°ì œ UI -->
            <div id="payment-method"></div>
            <!-- ì´ìš©ì•½ê´€ UI -->
            <div id="agreement"></div>
        </div>



        <!-- ê²°ì œ ê¸ˆì•¡ ìš”ì•½ -->
        <div class="section-title">ê²°ì œ ê¸ˆì•¡</div>

        <div class="price-box shadow-sm mb-4">

            <div class="d-flex justify-content-between my-1">
                <span>ìƒí’ˆ ê¸ˆì•¡</span>
                <strong th:text="${orderPrice.totalPrice} + 'ì›'"></strong>
            </div>

            <div class="d-flex justify-content-between my-1">
                <span>ë°°ì†¡ë¹„</span>
                <strong th:text="${orderPrice.deliveryFee} + 'ì›'"></strong>
            </div>

            <hr>

            <div class="d-flex justify-content-between">
                <span class="fw-bold">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                <strong class="text-danger" th:text="${orderPrice.finalPrice} + 'ì›'"></strong>
            </div>
        </div>


        <!-- ê²°ì œí•˜ê¸° ë²„íŠ¼ -->
        <div class="result wrapper">
            <button type="button" class="button" id="payment-button" style="margin-top: 30px">
                ê²°ì œí•˜ê¸°
            </button>
        </div>

    </form>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script th:inline="javascript">
    main();

    async function main() {
        const button = document.getElementById("payment-button");

        const amount = {
            currency: "KRW",
            value: 50000,
        };
        // ------  ê²°ì œìœ„ì ¯ ì´ˆê¸°í™” ------
        // TODO: clientKeyëŠ” ê°œë°œìì„¼í„°ì˜ ê²°ì œìœ„ì ¯ ì—°ë™ í‚¤ > í´ë¼ì´ì–¸íŠ¸ í‚¤ë¡œ ë°”ê¾¸ì„¸ìš”.
        // TODO: êµ¬ë§¤ìì˜ ê³ ìœ  ì•„ì´ë””ë¥¼ ë¶ˆëŸ¬ì™€ì„œ customerKeyë¡œ ì„¤ì •í•˜ì„¸ìš”. ì´ë©”ì¼ãƒ»ì „í™”ë²ˆí˜¸ì™€ ê°™ì´ ìœ ì¶”ê°€ ê°€ëŠ¥í•œ ê°’ì€ ì•ˆì „í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // @docs https://docs.tosspayments.com/sdk/v2/js#í† ìŠ¤í˜ì´ë¨¼ì¸ -ì´ˆê¸°í™”
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        const customerKey = /*[[${customerKey}]]*/ "";
        const finalPrice = Number(/*[[${orderPrice.finalPrice}]]*/ 0);

        const tossPayments = TossPayments(clientKey);
        // íšŒì› ê²°ì œ
        const widgets = tossPayments.widgets({
            customerKey,
        });
        // ë¹„íšŒì› ê²°ì œ
        // const widgets = tossPayments.widgets({customerKey: TossPayments.ANONYMOUS});

        // ------  ì£¼ë¬¸ì„œì˜ ê²°ì œ ê¸ˆì•¡ ì„¤ì • ------
        // TODO: renderPaymentMethods, renderAgreement, requestPayment ë³´ë‹¤ ë°˜ë“œì‹œ ì„ í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        await widgets.setAmount({currency: "KRW", value: finalPrice });

        // ------  ê²°ì œ UI ë Œë”ë§ ------
        // @docs https://docs.tosspayments.com/sdk/v2/js#widgetsrenderpaymentmethods
        await widgets.renderPaymentMethods({
            selector: "#payment-method",
            // ë Œë”ë§í•˜ê³  ì‹¶ì€ ê²°ì œ UIì˜ variantKey
            // ê²°ì œ ìˆ˜ë‹¨ ë° ìŠ¤íƒ€ì¼ì´ ë‹¤ë¥¸ ë©€í‹° UIë¥¼ ì§ì ‘ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´ ê³„ì•½ì´ í•„ìš”í•´ìš”.
            // @docs https://docs.tosspayments.com/guides/v2/payment-widget/admin#ìƒˆë¡œìš´-ê²°ì œ-ui-ì¶”ê°€í•˜ê¸°
            variantKey: "DEFAULT",
        });

        // ------  ì´ìš©ì•½ê´€ UI ë Œë”ë§ ------
        // @docs https://docs.tosspayments.com/reference/widget-sdk#renderagreementì„ íƒì-ì˜µì…˜
        await widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" });


        // ------ 'ê²°ì œí•˜ê¸°' ë²„íŠ¼ ëˆ„ë¥´ë©´ ê²°ì œì°½ ë„ìš°ê¸° ------
        // @docs https://docs.tosspayments.com/sdk/v2/js#widgetsrequestpayment
        button.addEventListener("click", async function (e) {

            e.preventDefault();
            try{
                // 1. ì„œë²„ì— ì£¼ë¬¸ ì¤€ë¹„ ìš”ì²­
                const form = document.querySelector("form");
                const res = await fetch("/orders/prepare", {
                    method: "POST",
                    body: new FormData(form),
                });

                if(!res.ok) {
                    alert("ì£¼ë¬¸ ì¤€ë¹„ ì‹¤íŒ¨");
                    return;
                }

                const prepared = await res.json();

                // 2. ê¸ˆì•¡ í™•ì •
                await widgets.setAmount({ currency: "KRW", value: Number(prepared.amount) });

                // 3. í† ìŠ¤ë¡œ ê²°ì œ ìš”ì²­
                await widgets.requestPayment({
                    orderId: prepared.orderId,
                    orderName: prepared.orderName,
                    successUrl:  prepared.successUrl,
                    failUrl:  prepared.failUrl,
                    customerName: prepared.customerName,
                    customerMobilePhone: prepared.customerMobilePhone,
                });

            } catch (err) {
                console.log(err);
                alert("ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
            }

        });
    }

    function generateRandomString() {
        return window.btoa(Math.random()).slice(0, 20);
    }

</script>

</body>
</html>
